<!--extentds-->
{% extends './common/base.html' %}

<!--title-->
{% block title %}搜索页面{% endblock %}

<!--sp_header-->
{% block sp_header %}
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<style>
    .carousel-control.right{
        background-image:none;
    }

    .carousel-control.left{
        background-image:none;
    }
</style>
{% endblock %}

<!--content-->
{% block content %}

<div class="search">
    <div class="search-content">
        <form class="search-condition form-horizontal">

            <div class="price-row form-group form-listen">
                <label class="search-category col-sm-2">价格：</label>

                <div class="col-sm-10">
                    <label for="noprice" class="checkbox-inline" style="margin-left:10px;">
                        <input type="radio" checked name="price" id="noprice"/>
                        不限
                    </label>

                    <label for="1000to1500" class="checkbox-inline">
                        <input type="radio" name="price" id="1000to1500"/>
                        1000-1500(含)
                    </label>


                    <label for="1500to2000" class="checkbox-inline">
                        <input type="radio" name="price" id="1500to2000"/>
                        1500-2000(含)
                    </label>

                    <label for="2000to3000" class="checkbox-inline">
                        <input type="radio" name="price" id="2000to3000"/>
                        2000-3000(含)
                    </label>

                    <label for="3000to5000" class="checkbox-inline">
                        <input type="radio" name="price" id="3000to5000"/>
                        3000-5000(含)
                    </label>


                    <label for="5000to8000" class="checkbox-inline">
                        <input type="radio" name="price" id="5000to8000"/>
                        5000-8000(含)
                    </label>


                    <label for="8000toh" class="checkbox-inline">
                        <input type="radio" name="price" id="8000toh"/>
                        8000以上
                    </label>
                </div>

            </div>

            <hr/>

            <div class="type-row form-group form-listen">
                <label class="search-category col-sm-2">户型：</label>

                <div class="col-sm-10">

                    <label for="notype" class="checkbox-inline" style="margin-left:10px;">
                        <input type="radio" checked name="type" id="notype"/>
                        不限
                    </label>

                    <label for="1room" class="checkbox-inline">
                        <input type="radio" name="type" id="1room"/>
                        1室
                    </label>


                    <label for="2room" class="checkbox-inline">
                        <input type="radio" name="type" id="2room"/>
                        2室
                    </label>


                    <label for="3room" class="checkbox-inline">
                        <input type="radio" name="type" id="3room"/>
                        3室
                    </label>


                    <label for="4roomup" class="checkbox-inline">
                        <input type="radio" name="type" id="4roomup"/>
                        4室（含以上）
                    </label>

                </div>


            </div>


            <hr/>

            <div class="way-row form-group form-listen">
                <label class="search-category col-sm-2">获取途径：</label>

                <div class="col-sm-10">
                    <label for="noway" class="checkbox-inline" style="margin-left:10px;">
                        <input type="radio" checked name="acheive_way" id="noway"/>
                        不限
                    </label>


                    <label for="mansion" class="checkbox-inline">
                        <input type="radio" name="acheive_way" id="mansion"/>
                        物业公司房源
                    </label>


                    <label for="area" class="checkbox-inline">
                        <input type="radio" name="acheive_way" id="area"/>
                        0中介费品牌公寓
                    </label>
                </div>

                <span id="more-way-btn" class="btn btn-pink">更多&nbsp;<span class="glyphicon glyphicon-menu-down" aria-hidden="true"></span></span>
                <span id="less-way-btn" class="btn btn-pink">收起&nbsp;<span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span></span>
            </div>

            <hr/>

            <div id="more-way-section">

                <div class="look-row form-group form-listen">
                    <label class="search-category col-sm-2">看房：</label>

                    <div class="col-sm-10">
                        <label for="nolook" class="checkbox-inline" style="margin-left:10px;">
                            <input type="radio" checked name="lookable" id="nolook"/>
                            不限
                        </label>


                        <label for="freelook" class="checkbox-inline">
                            <input type="radio" name="lookable" id="freelook"/>
                            随时可看
                        </label>


                        <label for="appolook" class="checkbox-inline">
                            <input type="radio" name="lookable" id="appolook"/>
                            预约可看
                        </label>
                    </div>

                </div>

                <hr/>

                <div class="time-row form-group form-listen">
                    <label class="search-category col-sm-2">入住时间：</label>

                    <div class="col-sm-10">
                        <input type="text" class="form-control" style="margin-left:30px;width:200px;" id="intime"/>
                    </div>

                </div>


                <hr/>

                <div class="photo-row form-group form-listen">
                    <label class="search-category col-sm-2">是否有电梯：</label>

                    <div class="col-sm-10">
                        <label for="noelevator" class="checkbox-inline" style="margin-left:10px;">
                            <input type="radio" checked name="elevator" id="noelevator"/>
                            不限
                        </label>

                        <label for="elevator-yes" class="checkbox-inline">
                            <input type="radio" name="elevator" id="elevator-yes"/>
                            有电梯
                        </label>

                        <label for="elevator-no" class="checkbox-inline">
                            <input type="radio" name="elevator" id="elevator-no"/>
                            无电梯
                        </label>
                    </div>

                </div>

                <hr/>

                <div class="elevator-row form-group form-listen">
                    <label class="search-category col-sm-2">是否有照片：</label>

                    <div class="col-sm-10">
                        <label for="nophoto" class="checkbox-inline" style="margin-left:10px;">
                            <input type="radio" checked name="photo" id="nophoto"/>
                            不限
                        </label>

                        <label for="photo-yes" class="checkbox-inline">
                            <input type="radio" name="photo" id="photo-yes"/>
                            有照片
                        </label>


                        <label for="photo-no" class="checkbox-inline">
                            <input type="radio" name="photo" id="photo-no"/>
                            无照片
                        </label>
                    </div>

                </div>


            </div>



        </form>
        <div class="search-result">
            <div class="row" id="search-result-container">

            </div>
        </div>
    </div>
    <div class="search-map" id="search-map">
        <div id="allmap" style="height:100%"></div>
    </div>
</div>

{% endblock %}

<!--sp_script-->
{% block sp_script %}

<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=gbADGzE7DryWx922MKlLKEnj"></script>
<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>

{% verbatim %}
<script id="house-item" type="text/x-jquery-tmpl">
{{if isValid}}
<div class="result-box col-lg-6">
    <a href="/room_detail/?roomNumber=${roomNumber}" target="_blank">
        <div class="result-image thumbnail" data-target="${roomNumber}">

            <div id="myCarousel${roomNumber}" class="carousel slide" style="height:200px;overflow:hidden">
               <div class="carousel-inner">
                    {{each(i,image) images}}
                        <div class="item {{if i==0 }}active{{/if}}">
                         <img src="${image}" alt="First slide" style="overflow:hidden;margin:0 auto;">
                      </div>
                    {{/each}}
               </div>

               <a class="left carousel-control" href="#myCarousel${roomNumber}" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="right carousel-control" href="#myCarousel${roomNumber}" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>

            <div class="result-desc">
                <div class="result-title">
                    ${addr_xiaoqu}
                </div>
                <div class="result-type">
                    ${type_room}室${type_livingroom}厅${type_toilet}卫
                </div>
                <div class="collect result-item {{if isCollected}}active{{/if}}" data-target="${roomNumber}">
                    <span class="glyphicon glyphicon-heart-empty" aria-hidden="true"></span>
                </div>
            </div>

            <div class="price-tag result-item">
                ${price}￥
            </div>
        </div>
    </a>
</div>

{{/if}}
</script>
{% endverbatim %}

<script type="text/javascript">

//    接受房源数据，并作初始化处理
    var rawData={{ rooms|safe }};

    for(var i=0;i<rawData.length;i++){
        rawData[i].isCollected=false;
        rawData[i].isValid=true;
    }

//    百度地图初始化

    var map = new BMap.Map("allmap");    // 创建Map实例
    map.centerAndZoom(new BMap.Point(120.200, 30.300), 12);  // 初始化地图,设置中心点坐标和地图级别
    map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
    map.setCurrentCity("杭州");          // 设置地图显示的城市 此项是必须设置的
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放

//    添加控件
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
    var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
    map.addControl(top_left_control);
    map.addControl(top_left_navigation);

//    复杂的自定义覆盖物
    function ComplexCustomOverlay(point, text, id){
        this._point = point;
        this._text = text;
        this._id = id;
    }
    ComplexCustomOverlay.prototype = new BMap.Overlay();
    ComplexCustomOverlay.prototype.initialize = function(map){
        this._map = map;
        var div = this._div = document.createElement("div");
        div.id="overlay"+this._id;
        div.style.position = "absolute";
        div.style.zIndex = BMap.Overlay.getZIndex(this._point.lat);
        div.style.backgroundColor = "#EE5D5B";
        div.style.border = "1px solid #BC3B3A";
        div.style.color = "white";
//        div.style.height = "18px";
        div.style.padding = "2px";
        div.style.lineHeight = "18px";
        div.style.whiteSpace = "nowrap";
        div.style.MozUserSelect = "none";
        div.style.fontSize = "12px";
        var span = this._span = document.createElement("span");
        div.appendChild(span);
        span.appendChild(document.createTextNode(this._text.toString()+"￥"));
        var that = this;

        var arrow = this._arrow = document.createElement("div");
        arrow.id="arrow"+this._id;
        arrow.style.background = "url(http://map.baidu.com/fwmap/upload/r/map/fwmap/static/house/images/label.png) no-repeat";
        arrow.style.position = "absolute";
        arrow.style.width = "11px";
        arrow.style.height = "10px";
        arrow.style.top = "22px";
        arrow.style.left = "10px";
        arrow.style.overflow = "hidden";
        div.appendChild(arrow);

//        div.onmouseover = function(){
//            this.style.backgroundColor = "#6BADCA";
//            this.style.borderColor = "#0000ff";
//            this.getElementsByTagName("span")[0].innerHTML = that._overText;
//            arrow.style.backgroundPosition = "0px -20px";
//        };
//
//        div.onmouseout = function(){
//            this.style.backgroundColor = "#EE5D5B";
//            this.style.borderColor = "#BC3B3A";
//            this.getElementsByTagName("span")[0].innerHTML = that._text;
//            arrow.style.backgroundPosition = "0px 0px";
//        };

        div.onclick = function(){
            window.open("/room_detail?roomNumber="+this.id.split("overlay")[1]);
        };

        map.getPanes().labelPane.appendChild(div);

        return div;
    };

    ComplexCustomOverlay.prototype.draw = function(){
        var map = this._map;
        var pixel = map.pointToOverlayPixel(this._point);
        this._div.style.left = pixel.x - parseInt(this._arrow.style.left) + "px";
        this._div.style.top  = pixel.y - 30 + "px";
    };

//    页面初始化
    $("nav").addClass("navbar-fixed-top");
    $("#more-way-section").hide();
    $("footer").remove();
    $("input[type=radio]").iCheck({
//        checkboxClass: 'icheckbox_flat-red',
        radioClass: 'iradio_flat-red'
    });

    $('#intime').datepicker({  dateFormat: "yy-mm-dd" });

    $("#more-way-btn").bind("click",function(){
        $(this).hide();
        $("#less-way-btn").show();
        $("#more-way-section").slideDown();
    });

    $("#less-way-btn").bind("click",function(){
        $(this).hide();
        $("#more-way-btn").show();
        $("#more-way-section").slideUp();
    });



</script>

<script>
    $(function(){

//        页面初始化搜索结果以及地图



        function freshResult(){
            $(".carousel").carousel('pause');
            //TODO:确定中心点和显示范围

            //清空并添加结果框
            $("#search-result-container").empty();
            $("#house-item").tmpl(rawData).appendTo('#search-result-container');

            //清空标记并添加新筛选过的标记
            map.clearOverlays();
            for(var i=0;i<rawData.length;i++){
                if(rawData[i].isValid){
                    var myCompOverlay = new ComplexCustomOverlay(new BMap.Point(rawData[i].lng,rawData[i].lat), rawData[i].price,rawData[i].roomNumber);
                    map.addOverlay(myCompOverlay);
                }
            }
        }

        freshResult();

        //鼠标进入房源区域，会在地图上高亮
        $('#search-result-container').delegate(".thumbnail","mouseover",function(e){
            var _id= $(this).data("target");
            $("#overlay"+_id).css({
                "background-color":"#6BADCA",
                "border-color":"#0000ff",
            });

            $("#arrow"+_id).css({
                "background-position":"0px -20px"
            });
        });

        //鼠标离开房源区域，会取消高亮
        $('#search-result-container').delegate(".thumbnail","mouseout",function(e){
            var _id= $(this).data("target");
            $("#overlay"+_id).css({
                "background-color":"#EE5D5B",
                "border-color":"#BC3B3A",
            });

            $("#arrow"+_id).css({
                "background-position":"0px 0px"
            });
        });

        //收藏功能
        $('#search-result-container').delegate(".collect","click",function(e){
            e.preventDefault();
            var _id=$(this).data("target");
            var that=$(this);

            $.post(
                "/room_collection",
                {roomNumber:_id},
                function(data){
                    if(data.status==200){
                        that.addClass("active");
                        console.log("post success");
                    }else{
                        console.log("post failed");
                    }
                }
            )
            .error(function(){
                console.log("error");
            });
        });


//        搜索条件改变后重新筛选后添加

        var price_upper=-1,
            price_lower=-1,
            room_type=-1,
            achive_type=-1,
            lookable_type=-1,
            photo=-1,
            elevator=-1,
            intime=-1;


        $('.form-listen input').on('ifChecked', function(e){
            //设定搜索的界限,-1表示没有限制
            var _target= e.target;
            var _type= _target.name;

            //根据表单变换去重新设置界限变量
            switch(_type) {
                case "price":
                    if (_target.id === "noprice") {
                        //没有价格限制
                        price_upper = -1;
                        price_lower = -1;
                    } else {
                        var price_bound = _target.id.split("to");
                        price_lower = price_bound[0];
                        price_upper = price_bound[1] === "h" ? -1 : price_bound[1];
                    }
                    break;
                case "type":
                    if (_target.id === "notype") {
                        //没有房型限制
                        room_type = -1;
                    } else {
                        room_type = _target.id.split("room")[0];
                    }
                    break;
                case "acheive_way":
                    if (_target.id === "noway") {
                        //没有限制
                        achive_type = -1;
                    } else {
                        achive_type = _target.id;
                    }
                    break;
                case "elevator":
                    if (_target.id === "noelevator") {
                        //没有限制
                        elevator = -1;
                    } else {
                        elevator = _target.id==="elevator-yes"?"yes":"no";
                    }
                    break;
                case "photo":
                    if (_target.id === "nophoto") {
                        //没有限制
                        photo = -1;
                    } else {
                        photo = _target.id==="photo-yes"?true:false;
                    }
                    break;
                case "lookable":
                    if (_target.id === "nolook") {
                        //没有限制
                        lookable_type = -1;
                    } else {
                        lookable_type = _target.id==="freelook"?"yes":"no";
                    }
                    break;
                default:
                    break;
            }

            //根据界限变量去遍历数组，筛选内容
            for(var i=0;i<rawData.length;i++){
                rawData[i].isValid=true;
                if((price_upper!=-1&&rawData[i].price>price_upper)
                        ||(price_lower!=-1&&rawData[i].price<=price_lower)
                        ||(room_type!=-1&&rawData[i].type_room!=room_type)
                        ||(achive_type!=-1&&rawData[i].status!=achive_type)
                        ||(lookable_type!=-1&&rawData[i].see!==lookable_type)
                        ||(photo!=-1&&((typeof rawData[i].images[0] === "undefined")===photo))
                        ||(elevator!=-1&&rawData[i].elevator!==elevator)){
                    rawData[i].isValid=false;
                }
            }

            //重新添加内容，并更新地图
            freshResult();
        });


        //地图拖动后重新请求房源
        map.addEventListener("dragend",mapDragHandler);

        function mapDragHandler(){

            // 判断用户勾选需求


            // 获取地图的边界
            var bounds = map.getBounds();
            var sw = bounds.getSouthWest();
            var ne = bounds.getNorthEast();

            $.post(
                    "{% url 'map_search' %}",
                    {
                        lng_left:sw.lng,//左下角坐标
                        lat_left:sw.lat,
                        lng_right:ne.lng,//右上角坐标
                        lat_right:ne.lat
                    },
                    function(data){
                        if(data.code==1){
                            rawData={{ data.newData|safe }};
                            freshResult();
                            console.log("post success");
                        }else{
                            console.log("post failed");
                        }
                    }
            )
                    .error(function(){
                        console.log("error");
                    });

        }
    });
</script>

{% endblock %}